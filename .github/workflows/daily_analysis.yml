name: æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´ 22:30 (UTC 14:30)
  schedule:
    - cron: '30 14 * * 1-5'     # å‘¨ä¸€åˆ°å‘¨äº”ï¼ŒUTC 14:30 = åŒ—äº¬æ—¶é—´ 22:30
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # å®Œæ•´åˆ†æï¼ˆè‚¡ç¥¨+å¤§ç›˜ï¼‰
          - market-only   # ä»…å¤§ç›˜å¤ç›˜
          - stocks-only   # ä»…è‚¡ç¥¨åˆ†æ

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªåˆ†æä»»åŠ¡
concurrency:
  group: stock-analysis
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    # æ·»åŠ è¶…æ—¶é™åˆ¶ï¼Œé˜²æ­¢ä»»åŠ¡å¡æ­»
    timeout-minutes: 30
    
    steps:
      - name: éšæœºå»¶è¿Ÿï¼ˆé¿å…å›ºå®šæ—¶é—´è®¿é—®ï¼‰
        run: sleep $((RANDOM % 60))  # éšæœºå»¶è¿Ÿ0-60ç§’å¯åŠ¨
      
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p data logs reports
      
      - name: æ‰§è¡Œè‚¡ç¥¨åˆ†æ
        env:
          # ==========================================
          # AI é…ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨ Kimi K2.5ï¼‰
          # ==========================================
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          
          # Gemini AIï¼ˆå¤‡ç”¨ï¼Œå¯é€‰ï¼‰
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: 'gemini-3-flash-preview'
          GEMINI_MODEL_FALLBACK: 'gemini-2.5-flash'
          GEMINI_REQUEST_DELAY: '3.0'
          
          # ==========================================
          # æ•°æ®æº
          # ==========================================
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          
          # ==========================================
          # æœç´¢æœåŠ¡ï¼ˆæ¨èé…ç½® Tavilyï¼‰
          # ==========================================
          BOCHA_API_KEYS: ${{ secrets.BOCHA_API_KEYS }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}
          
          # ==========================================
          # é€šçŸ¥æ¸ é“ - é‚®ç®±ï¼ˆå¿…é…ï¼‰
          # ==========================================
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
          EMAIL_SENDER_NAME: ${{ secrets.EMAIL_SENDER_NAME || 'daily_stock_analysisè‚¡ç¥¨åˆ†æåŠ©æ‰‹' }}
          
          # å…¶ä»–é€šçŸ¥æ¸ é“ï¼ˆå¯é€‰ï¼‰
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          SERVERCHAN3_SENDKEY: ${{ secrets.SERVERCHAN3_SENDKEY }}
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          
          # ==========================================
          # è‡ªé€‰è‚¡é…ç½®ï¼ˆä» Secrets è¯»å–ï¼‰
          # ==========================================
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          
          # ==========================================
          # è¿è¡Œé…ç½®
          # ==========================================
          REPORT_TYPE: ${{ secrets.REPORT_TYPE || 'full' }}
          SINGLE_STOCK_NOTIFY: 'false'
          MARKET_REVIEW_ENABLED: 'true'
          ANALYSIS_DELAY: '10'
          MAX_WORKERS: '3'
          LOG_LEVEL: INFO
          
        run: |
          echo "=========================================="
          echo "ğŸš€ è‚¡ç¥¨æ™ºèƒ½åˆ†æç³»ç»Ÿ"
          echo "=========================================="
          echo "â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“Š è‡ªé€‰è‚¡: ${{ secrets.STOCK_LIST }}"
          echo ""
          echo "ã€é…ç½®æ£€æŸ¥ã€‘"
          echo "  Kimi API: $([ -n "${{ secrets.OPENAI_API_KEY }}" ] && echo 'âœ…' || echo 'âŒ')"
          echo "  Gmail: $([ -n "${{ secrets.EMAIL_PASSWORD }}" ] && echo 'âœ…' || echo 'âŒ')"
          echo "=========================================="
          
          python main.py
      
      - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-reports-${{ github.run_number }}
          path: |
            reports/
            logs/
          retention-days: 30
